---
- name: Adding env in the startup files
  lineinfile:
    dest: ~/.zshrc
    regexp: ^export KUBE_ID=
    line: export KUBE_ID={{ kube_id }}
    state: present

- name: Show the kube_id
  debug:
    var: kube_id

- name: Save kubeconfig locally
  command: doctl kubernetes cluster kubeconfig save {{ kube_id }}

- name: Login to registry
  shell: doctl registry login

- name: Tag images for DOCR
  shell: docker tag {{ item }}:dev registry.digitalocean.com/{{ registry_name }}/{{ item }}:dev
  loop: "{{ registry_containers }}"

- name: Push images
  shell: docker push registry.digitalocean.com/{{ registry_name }}/{{ item }}:dev
  loop: "{{ registry_containers }}"

- name: Deploy config map to Kubernetes
  shell: kubectl apply -f {{ role_path }}/files/k8s/nginx-configmap.yaml

- name: Deploy pvc to Kubernetes
  shell: kubectl apply -f {{ role_path }}/files/k8s/db-pvc.yaml

- name: Deploy service to Kubernetes
  shell: kubectl apply -f {{ role_path }}/files/k8s/{{ item }}-service.yaml
  loop: "{{ service_containers }}"

- name: Deploy deployment to Kubernetes
  shell: kubectl apply -f {{ role_path }}/files/k8s/{{ item }}-deployment.yaml
  loop: "{{ deployment_containers }}"

- name: Get db service pod name
  command: kubectl get pod -l app={{ item }} -o jsonpath="{.items[0].metadata.name}"
  register: db_pod
  loop: "{{ db_containers }}"
  loop_control:
    label: "{{ item }}"

- name: Run rake db:create in each DB service pod
  command: kubectl exec {{ item.stdout }} -- rake db:create
  loop: "{{ db_pod.results }}"
  loop_control:
    label: "{{ item.item }}"

- name: Run rake db:migrate in each DB service pod
  command: kubectl exec {{ item.stdout }} -- rake db:migrate
  loop: "{{ db_pod.results }}"
  loop_control:
    label: "{{ item.item }}"
