- name: Copy build docker file to default file
  ansible.builtin.copy:
    src: "{{ root }}/docker-compose.build.yml"
    dest: "{{ root }}/docker-compose.yml"
    remote_src: yes
  tags:
    - dev

- name: Build Docker Compose images without starting containers
  ansible.builtin.command:
    cmd: docker-compose build
    chdir: "{{ root }}"
  environment:
    ENV: "{{ env }}"
  tags:
    - dev

- name: Add environment variable to user .bashrc
  ansible.builtin.lineinfile:
    path: ~/.bashrc
    line: 'export ENV="{{ env }}"'
    create: yes
  tags:
    - setup

- name: Install k3s
  ansible.builtin.shell: |
    curl -sfL https://get.k3s.io | sh -
  args:
    creates: /usr/local/bin/k3s
  tags:
    - setup

- name: Create client dev tar
  ansible.builtin.shell: |
    docker save client:dev -o {{ root }}/client-dev.tar
  tags:
    - dev

- name: Import client dev tar
  ansible.builtin.shell: |
    sudo ctr --address /run/k3s/containerd/containerd.sock -n k8s.io images import {{ root }}/client-dev.tar
  tags:
    - dev

- name: Tag client dev tar
  ansible.builtin.shell: |
    sudo ctr --address /run/k3s/containerd/containerd.sock -n k8s.io images tag docker.io/library/client:dev client:dev
  tags:
    - dev

- name: Create deployment
  ansible.builtin.shell: |
    sudo kubectl apply -f {{ root }}/k8s/client-deployment.yaml
  tags:
    - dev

- name: Create service
  ansible.builtin.shell: |
    sudo kubectl apply -f {{ root }}/k8s/client-service.yaml
  tags:
    - dev
