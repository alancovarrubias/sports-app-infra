---
- name: Adding env in the startup files
  lineinfile:
    dest: ~/.zshrc
    regexp: ^export KUBE_ID=
    line: export KUBE_ID={{ kube_id }}
    state: present

- name: Save kubeconfig locally
  command: doctl kubernetes cluster kubeconfig save {{ kube_id }}

- name: Login to registry
  shell: doctl registry login

- name: Tag images for DOCR
  shell: |
    docker tag client:dev registry.digitalocean.com/{{ registry_name }}/client:dev

- name: Push images
  shell: |
    docker push registry.digitalocean.com/{{ registry_name }}/client:dev

- name: Deploy config map to Kubernetes
  shell: kubectl apply -f {{ role_path }}/files/k8s/nginx-configmap.yaml

- name: Deploy service to Kubernetes
  shell: kubectl apply -f {{ role_path }}/files/k8s/client-service.yaml

- name: Deploy deployment to Kubernetes
  shell: kubectl apply -f {{ role_path }}/files/k8s/client-deployment.yaml
