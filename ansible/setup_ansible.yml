---
- name: Setup ansible server
  hosts: all
  gather_facts: no
  roles:
    - setup_server
    - role: setup_ssh_config
      vars:
        server_name: "ansible_server"
        env_var: "ANSIBLE_IP"

- name: Install ansible
  hosts: all
  gather_facts: no
  roles:
    - setup_server
    - role: setup_ssh_config
      vars:
        server_name: "ansible_server"
        env_var: "ANSIBLE_IP"
  tasks:
    - name: Update apt package cache (for Ubuntu)
      apt:
        update_cache: yes

    - name: Install Ansible dependencies
      apt:
        name:
          - ansible
          - python3-pip
        state: present
      register: result
      until: result is not failed
      retries: 5
      delay: 5

    - name: Install pip3 packages
      pip:
        name:
          - boto3
          - botocore
          - awscli
        executable: pip3
        state: present

- name: Setup ansible
  hosts: all
  gather_facts: no
  become: true
  become_user: "{{ user_name }}"
  roles:
    - setup_ansible
